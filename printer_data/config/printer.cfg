## Voron Design VORON2 250/300/350mm Spider TMC2209 UART config

## *** THINGS TO CHANGE/CHECK: ***
## MCU paths                           [mcu] section
## Thermistor types                    [extruder] and [heater_bed] sections - See https://www.klipper3d.org/Config_Reference.html#common-thermistors for common thermistor types
## Bed sensor_pin                      [heater_bed] section
## Fan pins                            [heater_fan hotend_fan] amd [fan] sections
## Z Endstop Switch location           [safe_z_home] section
## Homing end position                 [gcode_macro G32] section
## Z Endstop Switch  offset for Z0     [stepper_z] section
## Probe points                        [quad_gantry_level] section
## Min & Max gantry corner postions    [quad_gantry_level] section
## PID tune                            [extruder] and [heater_bed] sections
## Fine tune E steps                   [extruder] section

[include fluidd.cfg]
[include base.cfg]
[include klipper_config_eztbv2_simple.cfg]
[include calibration.cfg]
[include nevermore.cfg]
[include shell_command.cfg]

[mcu]
##  Obtain definition by "ls /dev/serial/by-id/*" 
##--------------------------------------------------------------------
#serial: /dev/serial/by-id/usb-Klipper_stm32f446xx_330037000351323438323636-if00
canbus_uuid: 757b79a07adb
## Uncomment below if you're using the Raspberry uart0 to communicate with Spider
#restart_method: command

[pause_resume]

[input_shaper]
# X轴：使用统计中值94.5 Hz，圆整为94.5
shaper_type_x: 3hump_ei
shaper_freq_x: 94.5
damping_ratio_x: 0.052  # 历史平均值

# Y轴：使用36.0 Hz - 针对高速优化
shaper_type_y: mzv
shaper_freq_y: 36.0
damping_ratio_y: 0.075  # 高速下表现优秀

[printer]
kinematics: corexy          #cxy系列
max_velocity: 300           #xy最大速度
max_accel: 4200             #xy最大加速度 Max 4000
max_z_velocity: 15          #z轴限制最大速度 Max 15 for 12V TMC Drivers, can increase for 24V
max_z_accel: 400            #z轴限制最大加速度
square_corner_velocity: 5.0

#####################################################################
#      X/Y Stepper Settings
#####################################################################

##  Connected to X-MOT (B Motor)
[stepper_x]
step_pin: PE11              #驱动步进脚
dir_pin: PE10               #驱动方向引脚，如果发现方向相反在前加！，例如本来是PA1发现反向那就改成！PA1
enable_pin: !PE9            #电机使能引脚，如果发现，未归位电机锁死，操作电机时不转并且此时电机没有锁死，在前面加！
rotation_distance: 40       #旋转一圈移动的距离，例如gt20，每一格2mm总共20格，转一圈就是20*2=40mm
microsteps: 16              #步进电机使用的细分数
# full_steps_per_rotation: 电机旋转一圈需要的步数，不算细分，例如1.8度电机为360/1.8=200
# set to 400 for 0.9 degree stepper
full_steps_per_rotation: 200  
endstop_pin: eztb:PB3
position_min: 0

##--------------------------------------------------------------------

##  Uncomment below for 250mm build
#position_endstop: 250
#position_max: 250

##  Uncomment for 300mm build
position_endstop: 300      #限位的位置
position_max: 300          #可移动的最大值

##  Uncomment for 350mm build
#position_endstop: 350
#position_max: 350

##--------------------------------------------------------------------
homing_speed: 120           #归位速度 Max 100

##  Make sure to update below for your relevant driver (2208 or 2209)
[tmc2209 stepper_x]
uart_pin: PE7
interpolate: true              # 啟用 256 微步內插，使運動更平滑
run_current: 0.9               # 運行電流 (RMS)。調整範圍：0.8 - 1.1
stealthchop_threshold: 0       # 設定為 0 表示永遠使用 StealthChop 靜音模式
sense_resistor: 0.110

##  Connected to Y-MOT (A Motor)
[stepper_y]
step_pin: PD8
dir_pin: PB12
enable_pin: !PD9
rotation_distance: 40
microsteps: 16
full_steps_per_rotation:200  #set to 400 for 0.9 degree stepper
endstop_pin: ^PB13
position_min: 0
##--------------------------------------------------------------------

##  Uncomment for 300mm build
position_endstop: 300
position_max: 300

##--------------------------------------------------------------------
homing_speed: 120
homing_retract_speed: 70    #第一次碰到限位回缩时候的速度 Max 100
homing_retract_dist: 5     #第一次碰到限位回缩距离
homing_positive_dir: true
second_homing_speed: 30     #第二次去触发限位时候的速度

##  Make sure to update below for your relevant driver (2208 or 2209)
[tmc2209 stepper_y]
uart_pin: PE15
interpolate: true              # 啟用 256 微步內插，使運動更平滑
run_current: 0.9               # 運行電流 (RMS)。調整範圍：0.8 - 1.1
stealthchop_threshold: 0       # 設定為 0 表示永遠使用 StealthChop 靜音模式
sense_resistor: 0.110

####################################################################################
#  Z轴步进电机 Z Stepper Settings
####################################################################################
#   z1 ----开关 --- z2
#   |              |
#   |              |
#   |              |
#   |              |
#   z0---显示屏--- z3
## In Z-MOT Position
## Z0 Stepper - Front Left
[stepper_z]
step_pin: PD14
dir_pin: PD13
enable_pin: !PD15
rotation_distance: 40
gear_ratio: 80:16
microsteps: 16                 # 與 TMC2209 配合的良好平衡點
##  In Z- Position
endstop_pin: probe:z_virtual_endstop
##  Z-position of nozzle (in mm) to z-endstop trigger point relative to print surface (Z0)
##  (+) value = endstop above Z0, (-) value = endstop below
##  Increasing position_endstop brings nozzle closer to the bed
##  After you run Z_ENDSTOP_CALIBRATE, position_endstop will be stored at the very end of your config
#position_endstop: -0.5
##--------------------------------------------------------------------

##  Uncomment below for 250mm build
#position_max: 210

##  Uncomment below for 300mm build
position_max: 260

##  Uncomment below for 350mm build
#position_max: 310

##--------------------------------------------------------------------
position_min: -5
homing_speed: 11
second_homing_speed: 3
homing_retract_dist: 3

##  Make sure to update below for your relevant driver (2208 or 2209)
[tmc2209 stepper_z]
uart_pin: PD10
interpolate: true              # 啟用內插，使運動更平滑
run_current: 0.7               # 【核心】運行電流。從這個安全的通用值開始
hold_current: 0.5              # 【核心】待機電流。防止龍門架下沉的關鍵！
stealthchop_threshold: 999     # 強制 Z 軸始終使用 StealthChop 模式（因為速度慢，靜音效果好）
sense_resistor: 0.110

##  In E0-MOT Position
##  Z1 Stepper - Rear Left
[stepper_z1]
step_pin: PE6
dir_pin: !PC13
enable_pin: !PE5
rotation_distance: 40
gear_ratio: 80:16
microsteps: 16

##  Make sure to update below for your relevant driver (2208 or 2209)
[tmc2209 stepper_z1]
uart_pin: PC14
interpolate: true
run_current: 0.7
hold_current: 0.6
stealthchop_threshold: 999
sense_resistor: 0.110

##  In E1-MOT Position
##  Z2 Stepper - Rear Right
[stepper_z2]
step_pin: PD5
dir_pin: PD6
enable_pin: !PD4
rotation_distance: 40
gear_ratio: 80:16
microsteps: 16

##  Make sure to update below for your relevant driver (2208 or 2209)
[tmc2209 stepper_z2]
uart_pin: PD7
interpolate: true
run_current: 0.7
hold_current: 0.6
stealthchop_threshold: 999
sense_resistor: 0.110

##  In E2-MOT Position
##  Z3 Stepper - Front Right
[stepper_z3]
step_pin: PE2
dir_pin: !PE4
enable_pin: !PE3
rotation_distance: 40
gear_ratio: 80:16
microsteps: 16

##  Make sure to update below for your relevant driver (2208 or 2209)
[tmc2209 stepper_z3]
uart_pin: PC15
interpolate: true
run_current: 0.7
hold_current: 0.6
stealthchop_threshold: 999
sense_resistor: 0.110


#####################################################################
#   Bed Heater
#####################################################################
##  SSR Pin - In BED OUT position
[heater_bed]
heater_pin: PB4
## Check what thermistor type you have. See https://www.klipper3d.org/Config_Reference.html#common-thermistors for common thermistor types.
## Use "Generic 3950" for Keenovo heaters
sensor_type: Generic 3950 # NTC 100K MGB18-104F39050L32

##--------------------------------------------------------------------
##  Select the option that matches your board
#sensor_pin: PC3 # Spider 1.0 & 1.1
#sensor_pin: PB0 # Spider 2.2
sensor_pin: PB0 # Spider 3.0 TB Position
##--------------------------------------------------------------------

##  Adjust max_power so it doesn't exceed the SSR rating. The Omron G3NA-210B-DC5 SSR is rated at 4 amps without a heatsink.
##  The formula is "4 / (Wattage_of_bed_heater / Mains_voltage) = max_power"
##  If max_power is greater than 1.0, use 1.0
max_power: 0.6
min_temp: 0
max_temp: 120
control = pid
pid_kp = 33.583
pid_ki = 1.349
pid_kd = 209.057
#control: pid
#pid_kp: 58.437
#pid_ki: 2.347
#pid_kd: 363.769

#####################################################################
#   Probe
#####################################################################

##  This probe is not used for Z height, only Quad Gantry Leveling
##  In Z+ position
# [probe]
# ##  If your probe is NO instead of NC, change pin to ^!PA3
# pin: ^PA3
# x_offset: 0
# y_offset: 0
# z_offset: 0
# speed: 10.0
# samples: 3
# samples_result: median
# sample_retract_dist: 3.0
# samples_tolerance: 0.006
# samples_tolerance_retries: 3

#####################################################################
#   Fan Control
#####################################################################

##  Hotend Fan - FAN0 Connector
# [heater_fan hotend_fan]
# ##  Select pin for your Spider board
# ##--------------------------------------------------------------------
# # pin: PB0   # Spider 1.0 & 1.1
# pin: PA13  # Spider 2.2, 3.0
# ##--------------------------------------------------------------------
# max_power: 1.0
# #kick_start_time: 0.5
# heater: extruder
# heater_temp: 50.0
# ##  If you are experiencing back flow, you can reduce fan_speed
# fan_speed: 1.0

##  Electrical Compartment Fan - FAN1 Connector
[fan_generic electrical_box_fan]
##--------------------------------------------------------------------
#pin: PB1   # Spider 1.0 & 1.1
pin: PB5  # Spider 2.2, 3.0
##--------------------------------------------------------------------
#max_power: 0.90
#off_below: 0.10
#kick_start_time: 0.5
#heater: heater_bed, extruder
#stepper: stepper_x, stepper_y, stepper_z
kick_start_time: 0.5           # 【可選】為風扇啟動提供一個短暫的全功率脈衝，有助於順利啟動
off_below: 0.0                 # 確保風扇在設定為0時完全關閉

# ========================
# 延遲G代碼：打印開始後開啟電氣倉風扇
# ========================
[delayed_gcode electrical_box_fan_control]  # 自定義一個延遲G代碼名稱
initial_duration: 1                         # 初始化後1秒鐘先執行一次
gcode:
  {% if printer.print_stats.state == "printing" %}
    # 當打印狀態變為「printing」時，將電氣倉風扇設定為100%功率
    SET_FAN_SPEED FAN=electrical_box_fan_control SPEED=1
  {% elif printer.print_stats.state == "complete" or printer.print_stats.state == "cancelled" or printer.print_stats.state == "error" %}
    # 當打印完成、取消或出錯時，等待一段時間（例如60秒）後關閉風扇
    UPDATE_DELAYED_GCODE ID=fan_off_delay DURATION=60
  {% endif %}

# 【可選】用於延遲關閉風扇的延遲G代碼
[gcode_macro fan_off_delay]
gcode:
  SET_FAN_SPEED FAN=electrical_box_fan_control SPEED=0 # 關閉電氣倉風扇


##  Controller fan - FAN2 Connector
# [heater_fan controller_fan]
# pin: PB2
# kick_start_time: 0.5
# heater: heater_bed
# heater_temp: 45.0

##  Exhaust fan - In E2 OUT Positon
#[heater_fan exhaust_fan]
#pin: PB3
#max_power: 1.0
#shutdown_speed: 0.0
#kick_start_time: 0.5
#heater: heater_bed
#heater_temp: 60
#fan_speed: 1.0

#####################################################################
#   LED Control
#####################################################################

#[output_pin caselight]
##  Chamber Lighting - In 5V-RGB Position
#pin: PD3
#pwm: true
#shutdown_value: 0
#value:100
#cycle_time: 0.01

#####################################################################
#   Homing and Gantry Adjustment Routines
#####################################################################

[idle_timeout]
timeout: 1800                       # 空闲时间超过30分钟则关闭热床

[safe_z_home]
# ##  XY Location of the Z Endstop Switch
# ##  Update -10,-10 to the XY coordinates of your endstop pin 
# ##  (such as 157,305) after going through Z Endstop Pin
# ##  Location Definition step.
home_xy_position:150,150    #Z归位时的X，Y坐标（例如100，100），在这个坐标上进行Z归位。
speed:300                  #工具头移动到安全Z原点的速度，默认为50毫米/秒
z_hop:10                   #在归位前抬升Z轴的距离（mm）。这将用于任何归位命令，即使它没有将Z轴归位。
z_hop_speed: 8            #在归位之前，Z轴抬升的速度（单位：mm/s），默认为15mm/s。
# move_to_previous: true     #当设置为 "True "时，X轴和Y轴在Z轴归位后会重置到之前的位置，默认为false。


#####################################################################
#   Bed Mesh Calibration
#####################################################################
[bed_mesh]
speed: 750                  # 校准期间非探测移动的速度(mm/s)
horizontal_move_z: 5            # 在探测中喷头的高度,单位是mm
mesh_min: 40, 40          # 定义矩形热床的最小X Y 坐标
mesh_max: 260,260             # 定义矩形热床的最大X Y 坐标

adaptive_margin: 10        
fade_start: 1                   # 启用fade_start时开始分阶段调整的gcode z位置
fade_end: 10                     # 在完成渐变后的gcode z 位置
probe_count: 5,5          # 对于矩形热床，这个逗号分开了在X Y 轴需要探测的点数
algorithm: bicubic              # 要使用的插值算法 #可以是"lagrange"或者"bicubic" #这个选项不会影响3x3的网格 因为3x3的网格会强制使用lagrange采样
bicubic_tension: 0.2            # 当使用bicubic算法时使用bicubic_tension参数来改变插值的斜率量 #较大的数字会增加斜率的数量会在网格中产生更多的弯曲
mesh_pps: 2,2              #补充采样点数
zero_reference_position: 150, 150

##  Use QUAD_GANTRY_LEVEL to level a gantry.
##  Min & Max gantry corners - measure from nozzle at MIN (0,0) and 
##  MAX (250, 250), (300,300), or (350,350) depending on your printer size
##  to respective belt positions
[quad_gantry_level]   
##  Gantry Corners for 300mm Build
gantry_corners:
   -60,-10
   360,370
##  Probe points
points:
   50,25
   50,225
   250,225
   250,25

speed: 750
horizontal_move_z: 5
retries: 5
retry_tolerance: 0.0075 #default retry_tolerance: 0.0075
max_adjust: 10



#####################################################################
#   Displays
#####################################################################

#--------------------------------------------------------------------

#   mini12864 LCD Display
#[display]
#lcd_type: uc1701
#cs_pin: PC11
#a0_pin: PD2
#rst_pin: PC10
#encoder_pins: ^PC6,^PC7
#click_pin: ^!PA8
#contrast: 63
##spi_bus: spi1
#spi_software_mosi_pin: PA7
#spi_software_miso_pin: PA6
#spi_software_sclk_pin: PA5

#   To control Neopixel RGB in mini12864 display
#[neopixel fysetc_mini12864]
#pin: PC12
#chain_count: 3
#initial_RED: 0.1
#initial_GREEN: 0.5
#initial_BLUE: 0.0
#color_order: RGB

#   Set RGB values on boot up for each Neopixel. 
#   Index 1 = display, Index 2 and 3 = Knob
#[delayed_gcode setdisplayneopixel]
#initial_duration: 1
#gcode:
#        SET_LED LED=fysetc_mini12864 RED=1 GREEN=1 BLUE=1 INDEX=1 TRANSMIT=0
#        SET_LED LED=fysetc_mini12864 RED=1 GREEN=0 BLUE=0 INDEX=2 TRANSMIT=0
#        SET_LED LED=fysetc_mini12864 RED=1 GREEN=0 BLUE=0 INDEX=3 

#--------------------------------------------------------------------

#####################################################################
#   Macros
#####################################################################
[gcode_macro PARK]
gcode:
    {% set th = printer.toolhead %}
    G0 X{th.axis_maximum.x//2} Y{th.axis_maximum.y//2} Z30  
    # G0 X150 Y150 Z30 F3600         # 300mm

## 打印头停到前面
[gcode_macro PARKF_RONT]
description: 打印头停到前面
gcode:
    #{% if printer.idle_timeout.state != "Printing" %}
        _CG28
        SAVE_GCODE_STATE NAME=park_front
        G90
        G0 X{printer.toolhead.axis_maximum.x / 2} Y{printer.toolhead.axis_minimum.y + 10} F10000
        RESTORE_GCODE_STATE NAME=park_front
    #{% else %}
    #    { action_respond_info("PARKFRONT disabled while printing!") }
    #{% endif %}

## 打印头停靠到中间
[gcode_macro PARK_CENTER]
description: 打印头停靠到中间
gcode:
    _CG28
    SAVE_GCODE_STATE NAME=part_center
    G90
    G0 X{printer.toolhead.axis_maximum.x / 2} Y{printer.toolhead.axis_maximum.y / 2} F10000
    RESTORE_GCODE_STATE NAME=part_center

## 打印头停靠到右后侧
[gcode_macro PARK_REARRIGHT]
description: 打印头停靠到右后侧
gcode:
    _CG28
    SAVE_GCODE_STATE NAME=park_rear_right
    G90
    G0 X{printer.toolhead.axis_maximum.x - 10} Y{printer.toolhead.axis_maximum.y - 10} F10000     
    RESTORE_GCODE_STATE NAME=park_rear_right

[gcode_macro G32]
gcode:
    SAVE_GCODE_STATE NAME=STATE_G32
    BED_MESH_CLEAR                 # 卸载网床
    G28                            # 归位所有轴
    QUAD_GANTRY_LEVEL              # 龙门架调平
    G28                            # 归位所有轴
    # 自适应网床探测
    STATUS_MESHING                 # 设置SB灯颜色
    BED_MESH_CALIBRATE profile=default adaptive=1 METHOD=scan SCAN_MODE=rapid
    # BED_MESH_PROFILE SAVE=printer
    RESTORE_GCODE_STATE NAME=STATE_G32

[gcode_macro M109]
rename_existing: M99109
gcode:
    #Parameters
    {% set s = params.S|float %}
    
    M104 {% for p in params %}{'%s%s' % (p, params[p])}{% endfor %}  ; Set hotend temp
    {% if s != 0 %}
        TEMPERATURE_WAIT SENSOR=extruder MINIMUM={s} MAXIMUM={s+1.2}   ; Wait for hotend temp (within 1 degree)
    {% endif %}

[gcode_macro M205]
description:设置拐角速度（抖动）
#报错M205就把它复制进你的配置文件
#M205（高级设置）（抖动设置相关）指令支持
gcode:
  {% if 'X' in params or 'Y' in params %}
     {% set corner_speed = (params.X|default(params.Y)|float,
         params.Y|default(params.X)|float)|min %}
     SET_VELOCITY_LIMIT SQUARE_CORNER_VELOCITY={corner_speed}
  {% else %}
     SET_VELOCITY_LIMIT
  {% endif %}

## 重置挤出机
[gcode_macro _RESET_EXTRUDER]
gcode:
    G92 E0
    
## 根据区域床尺寸自适应打印测试线，切片时尽量保证左测至少留空大于10
[gcode_macro _PURGE_LINE]
description: 在打印区域的左边打印一条线，让挤出机做好准备
gcode:
    {% set extruder_temp = params.EXTRUDER_TEMP %}
    {% set print_min_x = params.PRINT_MIN.split(",")[0]|int %}
    {% set print_min_y = params.PRINT_MIN.split(",")[1]|int %}
    _MESSAGE TEXT="参考最小坐标点：({print_min_x},{print_min_y})"                 # 将打印的最小坐标点信息输出到控制台
    {% if print_min_x > 25 %}                                                 # 如果最小坐标的X轴左边还有大于25mm的空间，则在打印区域的左边画线
        {% set line_start_x = print_min_x - 22 %}
        {% set line_end_x = print_min_x - 22 %}
        {% set line_start_y = print_min_y %}
        {% set line_end_y = print_min_y + 50 %}
    {% elif print_min_x < 25 and print_min_y > 25 %}                          # 如果最小坐标的X轴左边空间小于25mm，但是Y轴的下边有大于25mm的空间，则在打印区域的下边画线
        {% set line_start_x = print_min_x %}
        {% set line_end_x = print_min_x + 50 %}
        {% set line_start_y = print_min_y - 22 %}
        {% set line_end_y = print_min_y - 22 %}
    {% else %}                                                                # 如果两边空间都不足，强制在打印区域左边的床边缘画线
        {% set line_start_x = 5 %}
        {% set line_end_x = 5 %}
        {% set line_start_y = 5 %}
        {% set line_end_y = 55 %}
    {% endif %}
    _MESSAGE TEXT="移动到({line_start_x},{line_start_y})，加热热端，准备画线"      # 将打印头将要移动的目的坐标输出到控制台
    G90                                                                       # 切换到相对于原点的坐标系
    G1 X{line_start_x} Y{line_start_y} Z3 F6000                               # 移动到准备位置
    STATUS_HEATING                                                            # 设置SB灯颜色
    # M109 S{extruder_temp}                                                   # 等待热端到达指定温度
    G1 Z1 F1500                                                               # 下移喷嘴
    _RESET_EXTRUDER                                                           # 重置挤出机
    G1 E10 F150                                                               # 在原地挤出10mm耗材，黏住喷嘴上面的料
    _RESET_EXTRUDER                                                           # 重置挤出机
    G1 X{line_end_x} Y{line_end_y} Z0.25 F1500 E10                            # 画一条直线
    _RESET_EXTRUDER                                                           # 重置挤出机
    G1 Z2 F3000                                                               # 抬高喷嘴

[gcode_macro PRINT_START]
gcode:
    {% set PRINT_MIN = params.PRINT_MIN|default(290)|float %}
    {% set BED_TEMP = params.BED_TEMP|default(60)|float %}
    {% set EXTRUDER_TEMP = params.EXTRUDER_TEMP|default(150)|float %}
    STATUS_HEATING                 # 设置SB灯颜色
    M190 S{BED_TEMP}               # 设置热床温度并等待
    M109 S150                      # 设定喷嘴溫度为150度
    _RESET_EXTRUDER                # 重置挤出机
    # M104 S0 ; 停止 OrcaSlicer 單獨發送溫度等待訊息
    STATUS_PRINTING                # 开启RGB
    G32                            # 归位所有轴
    M109 S{EXTRUDER_TEMP}          # 设置热端温度并等待
    _PURGE_LINE EXTRUDER_TEMP={params.EXTRUDER_TEMP} PRINT_MIN={params.PRINT_MIN}    # 根据区域床尺寸自适应打印测试线
    TEMPERATURE_ADJUSTED_PRINT_START_SETTINGS
    STATUS_PRINTING                # 设置SB灯颜色
    _MESSAGE TEXT="開始列印"        # 输出消息

[gcode_macro PRINT_END]
#   Use PRINT_END for the slicer ending script - please customise for your slicer of choice
gcode:
    # safe anti-stringing move coords
    {% set th = printer.toolhead %}
    {% set x_safe = th.position.x + 20 * (1 if th.axis_maximum.x - th.position.x > 20 else -1) %}
    {% set y_safe = th.position.y + 20 * (1 if th.axis_maximum.y - th.position.y > 20 else -1) %}
    {% set z_safe = [th.position.z + 5, th.axis_maximum.z]|min %}
    
    SAVE_GCODE_STATE NAME=STATE_PRINT_END

    G90                                                                                                     # 切换到相对于原点的坐标系
    G0 X{x_safe} Y{y_safe} Z{z_safe} F20000                                                                 # 抬高喷嘴避免烫坏打印件
    M400                                                                                                    # 等待缓存清空
    _RESET_EXTRUDER                                                                                         # 重置挤出机
    G1 E-5.0 F1800                                                                                          # 回抽5mm
    TURN_OFF_HEATERS                                                                                        # 关闭喷头加热
    G0 X{th.axis_maximum.x - 20} Y{th.axis_maximum.y - 20} Z{th.position.z + 50 if th.position.z < 100 else z_safe} F3600        # 停到指定位置
    M84                                                                                                     # 关闭步进电机
    M107                                                                                                    # 关闭模型散热风扇
    NEVERMORE_OFF                                                                                           # 关闭内循环
    G4 P3000   # 等待3秒                                                                         
    BED_MESH_CLEAR
    _MESSAGE TEXT="結束列印"        # 输出消息

    # The purpose of the SAVE_GCODE_STATE/RESTORE_GCODE_STATE
    # command pair is to restore the printer's coordinate system
    # and speed settings since the commands above change them.
    # However, to prevent any accidental, unintentional toolhead
    # moves when restoring the state, explicitly set MOVE=0.
    RESTORE_GCODE_STATE NAME=STATE_PRINT_END MOVE=0


## 取消打印
[gcode_macro CANCEL_PRINT]
description: 取消打印
rename_existing: BASE_CANCEL_PRINT
gcode:
    {% set th = printer.toolhead %}
    {% set z_safe = [th.position.z + 5, th.axis_maximum.z]|min %}
    M400                                                                                                   # 等待缓存清空
    TURN_OFF_HEATERS
    G90                                                                                                    # 切换到相对于原点的坐标系
    _RESET_EXTRUDER                                                                                      # 重置挤出机
    G1 E-5.0 F1800                                                                                         # 回抽5mm
    G0 X{th.axis_maximum.x - 20} Y{th.axis_maximum.y - 20} Z{th.position.z + 50 if th.position.z < 100 else z_safe} F3600        # 停到指定位置
    BASE_CANCEL_PRINT
    CLEAR_PAUSE
    # SDCARD_RESET_FILE
    BED_MESH_CLEAR
    {action_respond_info("取消打印")}

## 暂停打印
[gcode_macro PAUSE]
description: 暂停打印
rename_existing: BASE_PAUSE
variable_extrude: 5.0    # 暂停时耗材回抽量
gcode:
    #{% set E = printer["gcode_macro PAUSE"].extrude|float %}           # 从变量获取回抽量
    #{% set x_park = printer.toolhead.axis_maximum.x|float - 5.0 %}     # 设置停靠的X坐标
    #{% set y_park = printer.toolhead.axis_maximum.y|float - 5.0 %}     # 设置停靠的Y坐标
    {% set max_z = printer.toolhead.axis_maximum.z|float %}            # Z轴最大值
    {% set act_z = printer.toolhead.position.z|float %}                # Z轴当前坐标
    {% if (max_z - act_z) > 100.0 %}                                     # 判断并设置Z轴抬升量
        {% set z_safe = 100.0 %}
    {% else %}
        {% set z_safe = max_z - act_z %}
    {% endif %}
    SAVE_GCODE_STATE NAME=PAUSE_STATE                               # 保存当前位置坐标
    BASE_PAUSE                                                       # 暂停打印
    G91                                                               # 相对当前位置的坐标系
    #G1 E-{E} F2100                                                   # 回抽耗材
    G1 Z{z_safe} F900                                                # 抬升Z到安全坐标
    #G90                                                              # 相对原点的坐标系
    #G1 X{x_park} Y{y_park} F6000                                     # 移动到停靠点
    {action_respond_info("暂停打印")}

## 恢复打印
[gcode_macro RESUME]
description: 恢复打印
rename_existing: BASE_RESUME
gcode:
    #{% set E = printer["gcode_macro PAUSE"].extrude|float %}           # 从变量获取回抽量
    #CLEAN_NOZZLE                                                      # 清理喷嘴
    #G91                                                               # 相对当前位置的坐标系
    #G1 E{E} F2100                                                    # 挤出耗材
    RESTORE_GCODE_STATE NAME=PAUSE_STATE                           # 恢复到暂停前位置
    BASE_RESUME                                                     # 恢复打印
    {action_respond_info("恢复打印")}

[shaketune]
# result_folder: ~/printer_data/config/ShakeTune_results
#    Path where the processed results will be stored. If the folder doesn't exist,
#    it will be automatically created. You can change this if you'd like to store 
#    results in a different location.
# number_of_results_to_keep: 10
#    This setting defines how many results you want to keep in the result folder.
#    Once the specified number is exceeded, older results will be automatically deleted
#    to free up space on the SD card and avoid cluttering the results folder.
# keep_raw_data: False
#    If set to True, Shake&Tune will store both the processed graphs and the raw accelerometer
#    .stdata files in the results folder. This can be useful for debugging or archiving purposes.
#    Please always attach them when reporting any issues on GitHub or Discord.
# show_macros_in_webui: True
#    Mainsail and Fluidd doesn't create buttons for system commands (macros that are not part
#    of the printer.cfg file). This option allow Shake&Tune to inject them into the webui at runtime.
#    If set to False, the macros will be hidden but still accessible from the console by typing
#    their names manually, which can be useful if you prefer to encapsulate them into your own macros.
# timeout: 600
#    This defines the maximum processing time (in seconds) to allows to Shake&Tune for generating 
#    graphs from a .stdata file. 10 minutes should be more than enough in most cases, but if you have
#    slower hardware (e.g., older SD cards or low-performance devices), increase it to prevent timeouts.
# measurements_chunk_size: 2
#    Each Shake&Tune command uses the accelerometer to take multiple measurements. By default,
#    Shake&Tune will write a chunk of data to disk every two measurements, and at the end of the
#    command will merge these chunks into the final .stdata file for processing. "2" is a very
#    conservative setting to avoid Klipper Timer Too Close errors on lower end devices with little
#    RAM, and should work for everyone. However, if you are using a powerful computer, you may
#    wish to increase this value to keep more measurements in memory (e.g., 15-20) before writing
#    the chunk and avoid stressing the filesystem too much.
# max_freq: 200
#    This setting defines the maximum frequency at which the calculation of the power spectral density
#    is cutoff. The default value should be fine for most machines and accelerometer combinations and
#    avoid touching it unless you know what you're doing.
# dpi: 300
#    Controls the resolution of the generated graphs. The default value of 300 dpi was optimized
#    and strikes a balance between performance and readability, ensuring that graphs are clear
#    without using too much RAM to generate them. Usually, you shouldn't need to change this value.


##  Thermistor Types
##   "EPCOS 100K B57560G104F"
##   "ATC Semitec 104GT-2"
##   "NTC 100K beta 3950"
##   "Honeywell 100K 135-104LAG-J01"
##   "NTC 100K MGB18-104F39050L32" (Keenovo Heater Pad)
##   "AD595"
##   "PT100 INA826"

#*# <---------------------- SAVE_CONFIG ---------------------->
#*# DO NOT EDIT THIS BLOCK OR BELOW. The contents are auto-generated.
#*#
#*# [probe]
#*# z_offset = -2.000
#*#
#*# [bed_mesh default]
#*# version = 1
#*# points =
#*# 	-0.057500, -0.070000, -0.090000, -0.067500, -0.007500
#*# 	-0.012500, -0.027500, -0.045000, -0.012500, 0.002500
#*# 	0.030000, -0.000000, 0.000000, 0.010000, 0.012500
#*# 	-0.005000, -0.045000, -0.055000, -0.035000, 0.000000
#*# 	-0.125000, -0.105000, -0.112500, -0.100000, -0.035000
#*# x_count = 5
#*# y_count = 5
#*# mesh_x_pps = 2
#*# mesh_y_pps = 2
#*# algo = bicubic
#*# tension = 0.2
#*# min_x = 40.0
#*# max_x = 260.0
#*# min_y = 40.0
#*# max_y = 260.0
